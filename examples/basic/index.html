<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dexie Migrate - Basic Example</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.6;
    }
    h1 {
      color: #333;
    }
    .status {
      background: #f0f0f0;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üóÑÔ∏è Dexie Migrate - Basic Example</h1>
  
  <div class="status" id="status">
    <p>Initializing database...</p>
  </div>

  <div>
    <button id="addForm">Add Sample Form</button>
    <button id="listForms">List All Forms</button>
    <button id="clearDb">Clear Database</button>
  </div>

  <div>
    <h2>Output:</h2>
    <pre id="output">Check the browser console for detailed logs.</pre>
  </div>

  <script type="module">
    import { runMigrations } from '../../dist/index.mjs';
    import Dexie from 'https://cdn.jsdelivr.net/npm/dexie@4/+esm';

    // Make Dexie available globally for the migrations
    window.Dexie = Dexie;

    // Define migrations
    const migrations = [
      {
        id: 1,
        name: 'initial_schema',
        stores: {
          forms: 'id, name, createdAt'
        }
      },
      {
        id: 2,
        name: 'add_updated_at',
        stores: {
          forms: 'id, name, createdAt, updatedAt'
        },
        async up(tx) {
          const now = Date.now();
          await tx.table('forms').toCollection().modify(form => {
            form.updatedAt = form.updatedAt ?? now;
          });
          console.log('‚úì Added updatedAt field to all forms');
        }
      }
    ];

    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');

    function setStatus(message, success = false) {
      statusEl.innerHTML = `<p>${message}</p>`;
      statusEl.className = success ? 'status success' : 'status';
    }

    function log(message) {
      console.log(message);
      outputEl.textContent = message;
    }

    // Initialize database
    async function init() {
      try {
        console.log('Starting migration...');
        
        const result = await runMigrations('example-db', migrations, {
          verbose: true,
          onProgress: (current, total) => {
            console.log(`Migration progress: ${current}/${total}`);
          }
        });

        window.db = result.db;

        setStatus(`
          ‚úì Database initialized successfully!<br>
          Applied: ${result.appliedMigrations.length} migrations<br>
          Skipped: ${result.skippedMigrations.length} migrations<br>
          Version: ${result.finalVersion}
        `, true);

        log(`Database ready!\nApplied migrations: ${JSON.stringify(result.appliedMigrations)}\nSkipped migrations: ${JSON.stringify(result.skippedMigrations)}`);

        // List existing forms
        const forms = await db.forms.toArray();
        if (forms.length > 0) {
          log(`Found ${forms.length} existing forms:\n${JSON.stringify(forms, null, 2)}`);
        }
      } catch (error) {
        console.error('Migration failed:', error);
        setStatus(`‚úó Migration failed: ${error.message}`);
        log(`Error: ${error.message}`);
      }
    }

    // Add sample form
    document.getElementById('addForm').addEventListener('click', async () => {
      try {
        const id = await db.forms.add({
          name: `Form ${Date.now()}`,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        log(`‚úì Added form with ID: ${id}`);
      } catch (error) {
        log(`‚úó Error adding form: ${error.message}`);
      }
    });

    // List all forms
    document.getElementById('listForms').addEventListener('click', async () => {
      try {
        const forms = await db.forms.toArray();
        log(`Found ${forms.length} forms:\n${JSON.stringify(forms, null, 2)}`);
      } catch (error) {
        log(`‚úó Error listing forms: ${error.message}`);
      }
    });

    // Clear database
    document.getElementById('clearDb').addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear the database?')) {
        try {
          await db.close();
          await Dexie.delete('example-db');
          log('‚úì Database cleared. Refresh the page to reinitialize.');
          setStatus('Database cleared. Refresh the page to reinitialize.');
        } catch (error) {
          log(`‚úó Error clearing database: ${error.message}`);
        }
      }
    });

    // Initialize on load
    init();
  </script>
</body>
</html>
